<!doctype html><html lang=en><head><title>Implementing a Merkle tree in Python ::
trebaud
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Unless you&amp;rsquo;ve been living under a rock for the past few years you have probably heard of Bitcoin, the decentralized, peer-to-peer, public, trustless, cash system protocol. Regardless of whether or not you think bitcoin&amp;rsquo;s current valuation is in a bubble or worse that it&amp;rsquo;s a Ponzi scheme, it&amp;rsquo;s undeniable that the protocol solves a real and old problem in distributed computing, a.k.a the Byzantine&amp;rsquo;s General Problem. One of the underlying data structures ensuring the immutability of the blockchain is the Merkle tree."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://trebaud.github.io/posts/merkle-tree/><link rel=stylesheet href=https://trebaud.github.io/assets/style.css><link rel=stylesheet href=https://trebaud.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://trebaud.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://trebaud.github.io/img/favicon.png><link href=https://trebaud.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://trebaud.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://trebaud.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://trebaud.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://trebaud.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://trebaud.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://trebaud.github.io/"><meta name=twitter:title content="Implementing a Merkle tree in Python"><meta name=twitter:description content="Build a Merkle tree in Python"><meta property="og:title" content="Implementing a Merkle tree in Python"><meta property="og:description" content="Build a Merkle tree in Python"><meta property="og:type" content="article"><meta property="og:url" content="https://trebaud.github.io/posts/merkle-tree/"><meta property="og:image" content="https://trebaud.github.io/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-01-06T00:00:00-05:00"><meta property="article:modified_time" content="2018-01-06T00:00:00-05:00"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4BDVPG70H1"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4BDVPG70H1",{anonymize_ip:!1})}</script><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-4BDVPG70H1","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>$ cd /home/trebaud</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/posts>cd ~/posts</a></li><li><a href=/whoami>whoami</a></li><ul class=menu__sub-inner><li class=menu__sub-inner-more-trigger>Show more
<span class=menu__sub-inner-more-trigger-icon><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span></li><ul class="menu__sub-inner-more hidden"><li><a href=/tags>üîç tags</a></li><li><a href=/neck-visualizer>üé∏ guitar</a></li></ul></ul></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/posts>cd ~/posts</a></li><li><a href=/whoami>whoami</a></li><li><a href=/tags>üîç tags</a></li><li><a href=/neck-visualizer>üé∏ guitar</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Implementing a Merkle tree in Python</h1><div class=post-meta><span class=post-date>2018-01-06
</span><span class=post-read-time>‚Äî 3 min read</span></div><span class=post-tags><a href=https://trebaud.github.io/tags/development/>#development</a>&nbsp;
<a href=https://trebaud.github.io/tags/bitcoin/>#bitcoin</a>&nbsp;</span><div class=post-content><p>Unless you&rsquo;ve been living under a rock for the past few years you have probably heard of Bitcoin, the decentralized, peer-to-peer, public, trustless, cash system protocol. Regardless of whether or not you think bitcoin&rsquo;s current valuation is in a bubble or worse that it&rsquo;s a Ponzi scheme, it&rsquo;s undeniable that the protocol solves a real and old problem in distributed computing, a.k.a the <a href="https://en.wikipedia.org/wiki/Byzantine_fault_tolerance#Byzantine_Generals'_Problem">Byzantine&rsquo;s General Problem</a>. One of the underlying data structures ensuring the immutability of the blockchain is the Merkle tree.</p><p>A Merkle tree is a binary tree in which each leaf node is a hash of a block of data and each internal node is a hash of its children. In the bitcoin protocol it ensures the immutability of the set of transactions by taking the hash of each data transaction and generating a single unique root hash representing the hash of the entire set.</p><p><img src=/img/merkletree.png alt=merkle-tree></p><p>In this post we&rsquo;ll look at a possible implementation of a Merkle tree in python using the typing module. If you&rsquo;re not familiar with typing you can take a look at my last <a href=%7B%7Bsite.url%7D%7D/2017/12/27/typing-python.html>post</a> where I go a little more in depth on how to use this module.
The API for the Merkle tree data structure is very straightforward and consists of a single method which exposes the root hash of the tree. The constructor takes a list of objects from which we wish to build our tree.</p><p>Our Node class stores its hash and a reference to the left and right child nodes. We&rsquo;ll add two static methods to do the hashing using the SHA-256 algorithm. We&rsquo;ll apply the hashing two times for an extra level of security. Because of the way the Merkle tree is structured we need an even number of leaf nodes to build our tree. If we have an odd number of data blocks then we just hash the last one two times, duplicating the last leaf node.</p><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> typing <span style=color:#f92672>import</span> List
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> typing
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> hashlib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Node</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, left, right, value: str)<span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>left: Node <span style=color:#f92672>=</span> left
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>right: Node <span style=color:#f92672>=</span> right
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>value <span style=color:#f92672>=</span> value
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>hash</span>(val: str)<span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> hashlib<span style=color:#f92672>.</span>sha256(val<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>))<span style=color:#f92672>.</span>hexdigest()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>doubleHash</span>(val: str)<span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Node<span style=color:#f92672>.</span>hash(Node<span style=color:#f92672>.</span>hash(val))
</span></span></code></pre></div><p>Then the Merkle tree class itself comprised of two methods for recursively building the tree, two others for printing the nodes in prefix order and the one we mentionned earlier for getting the root hash.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>MerkleTree</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, values: List[str])<span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__buildTree(values)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__buildTree</span>(self, values: List[str])<span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        leaves: List[Node] <span style=color:#f92672>=</span> [Node(<span style=color:#66d9ef>None</span>, <span style=color:#66d9ef>None</span>, Node<span style=color:#f92672>.</span>doubleHash(e)) <span style=color:#66d9ef>for</span> e <span style=color:#f92672>in</span> values]
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>root: Node <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__buildTreeRec(leaves)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__buildTreeRec</span>(self, nodes: List[Node])<span style=color:#f92672>-&gt;</span> Node:
</span></span><span style=display:flex><span>        half: int <span style=color:#f92672>=</span> len(nodes) <span style=color:#f92672>//</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(nodes) <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Node(nodes[<span style=color:#ae81ff>0</span>], nodes[<span style=color:#ae81ff>0</span>], Node<span style=color:#f92672>.</span>doubleHash(nodes[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> len(nodes) <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Node(nodes[<span style=color:#ae81ff>0</span>], nodes[<span style=color:#ae81ff>1</span>], Node<span style=color:#f92672>.</span>doubleHash(nodes[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>.</span>value <span style=color:#f92672>+</span> nodes[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>value))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        left: Node <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__buildTreeRec(nodes[:half])
</span></span><span style=display:flex><span>        right: Node <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>__buildTreeRec(nodes[half:])
</span></span><span style=display:flex><span>        value: str <span style=color:#f92672>=</span> Node<span style=color:#f92672>.</span>doubleHash(left<span style=color:#f92672>.</span>value <span style=color:#f92672>+</span> right<span style=color:#f92672>.</span>value)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> Node(left, right, value)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>printTree</span>(self)<span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>__printTreeRec(self<span style=color:#f92672>.</span>root)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>__printTreeRec</span>(self, node)<span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> node <span style=color:#f92672>!=</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>            print(node<span style=color:#f92672>.</span>value)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>__printTreeRec(node<span style=color:#f92672>.</span>left)
</span></span><span style=display:flex><span>            self<span style=color:#f92672>.</span>__printTreeRec(node<span style=color:#f92672>.</span>right)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getRootHash</span>(self)<span style=color:#f92672>-&gt;</span> str:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> self<span style=color:#f92672>.</span>root<span style=color:#f92672>.</span>value
</span></span></code></pre></div><p>We can then test our data structure by sending in a list of strings and getting its corresponding merkle tree root hash.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test</span>()<span style=color:#f92672>-&gt;</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>    elems <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;Hello&#34;</span>, <span style=color:#e6db74>&#34;mister&#34;</span>, <span style=color:#e6db74>&#34;Merkle&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(elems) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>Exception</span>(<span style=color:#e6db74>&#34;Your list is empty, provide at least one element.&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    mtree <span style=color:#f92672>=</span> MerkleTree(elems)
</span></span><span style=display:flex><span>    print(mtree<span style=color:#f92672>.</span>getRootHash())
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~$ python3.6 merkletree.py
</span></span><span style=display:flex><span>eac44a171f264412cc5744b9e206fcfb2ce77c1e9dc64d17a56ef7cc5eb386c7
</span></span></code></pre></div><p>That&rsquo;s it! Feel free to try this code and improve it at will.</p><p>Bye for now!</p></div><hr><div class=sharing-buttons><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?url=https%3a%2f%2ftrebaud.github.io%2fposts%2fmerkle-tree%2f" target=_blank rel=noopener aria-label title="Share on twitter"><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2ftrebaud.github.io%2fposts%2fmerkle-tree%2f&amp;resubmit=true&amp;title=Implementing%20a%20Merkle%20tree%20in%20Python" target=_blank rel=noopener aria-label title="Share on reddit"><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2ftrebaud.github.io%2fposts%2fmerkle-tree%2f&amp;t=Implementing%20a%20Merkle%20tree%20in%20Python" target=_blank rel=noopener aria-label title="Share on hacker news"><div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentcolor" stroke="none"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg></div></div></a></div><script src=https://utteranc.es/client.js repo=trebaud/trebaud.github.io issue-term=pathname theme=github-light crossorigin=anonymous async></script><noscript>Please enable JavaScript to view the <a href=https://github.com/utterance>comments powered by utterances.</a></noscript></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>$ cd /home/trebaud</span>
<span class=logo__cursor></span></a><div class=copyright><span>¬© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://trebaud.github.io/assets/main.js></script><script src=https://trebaud.github.io/assets/prism.js></script></div></body></html>