<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Implementing a Merkle tree in Python - Yet another tech blog</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="Implementing a Merkle tree in Python"><meta itemprop=description content="Build a Merkle tree in Python"><meta itemprop=datePublished content="2018-01-06T00:00:00-05:00"><meta itemprop=dateModified content="2018-01-06T00:00:00-05:00"><meta itemprop=wordCount content="553"><meta itemprop=keywords content="development,"><meta property="og:title" content="Implementing a Merkle tree in Python"><meta property="og:description" content="Build a Merkle tree in Python"><meta property="og:type" content="article"><meta property="og:url" content="https://trebaud.github.io/posts/merkle-tree/"><meta property="article:published_time" content="2018-01-06T00:00:00-05:00"><meta property="article:modified_time" content="2018-01-06T00:00:00-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Implementing a Merkle tree in Python"><meta name=twitter:description content="Build a Merkle tree in Python"><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://trebaud.github.io/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://trebaud.github.io/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://trebaud.github.io/css/dark.css><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script><script src=https://trebaud.github.io/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://trebaud.github.io/><img src="https://avatars2.githubusercontent.com/u/8050949?s=400&v=4" alt="Yet another tech blog"></a></div><h1 class=site-title><a href=https://trebaud.github.io/>Yet another tech blog</a></h1><div class=site-description><p>A collection of loosely coupled ramblings about tech, coding and life.</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/trebaud title=Github><i data-feather=github></i></a></li><li><a href=https://www.linkedin.com/in/thomas-rebaud-8017a168/ title=Linkedin><i data-feather=linkedin></i></a></li><li><a href=# class=scheme-toggle id=scheme-toggle></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>üè† Home</a></li><li><a href=/posts>üìù All posts</a></li><li><a href=/about>üë®‚Äçüíª About</a></li><li><a href=/tags>üîç Tags</a></li></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>06</span>
<span class=rest>Jan 2018</span></div></div><div class=matter><h1 class=title>Implementing a Merkle tree in Python</h1></div></div><div class=markdown><p>Unless you&rsquo;ve been living under a rock for the past few years you have probably heard of Bitcoin, the decentralized, peer-to-peer, public, trustless, cash system protocol. Regardless of whether or not you think bitcoin&rsquo;s current valuation is in a bubble or worse that it&rsquo;s a Ponzi scheme, it&rsquo;s undeniable that the protocol solves a real and old problem in distributed computing, a.k.a the <a href="https://en.wikipedia.org/wiki/Byzantine_fault_tolerance#Byzantine_Generals'_Problem">Byzantine&rsquo;s General Problem</a>. One of the underlying data structures ensuring the immutability of the blockchain is the Merkle tree.</p><p>A Merkle tree is a binary tree in which each leaf node is a hash of a block of data and each internal node is a hash of its children. In the bitcoin protocol it ensures the immutability of the set of transactions by taking the hash of each data transaction and generating a single unique root hash representing the hash of the entire set.</p><p><img src=/img/merkletree.png alt=merkle-tree></p><p>In this post we&rsquo;ll look at a possible implementation of a Merkle tree in python using the typing module. If you&rsquo;re not familiar with typing you can take a look at my last <a href=%7B%7Bsite.url%7D%7D/2017/12/27/typing-python.html>post</a> where I go a little more in depth on how to use this module.
The API for the Merkle tree data structure is very straightforward and consists of a single method which exposes the root hash of the tree. The constructor takes a list of objects from which we wish to build our tree.</p><p>Our Node class stores its hash and a reference to the left and right child nodes. We&rsquo;ll add two static methods to do the hashing using the SHA-256 algorithm. We&rsquo;ll apply the hashing two times for an extra level of security. Because of the way the Merkle tree is structured we need an even number of leaf nodes to build our tree. If we have an odd number of data blocks then we just hash the last one two times, duplicating the last leaf node.</p><hr><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> <span style=color:#111>typing</span> <span style=color:#f92672>import</span> <span style=color:#111>List</span>
<span style=color:#f92672>import</span> <span style=color:#111>typing</span>
<span style=color:#f92672>import</span> <span style=color:#111>hashlib</span>

<span style=color:#00a8c8>class</span> <span style=color:#75af00>Node</span><span style=color:#111>:</span>
    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>None</span><span style=color:#111>:</span>
        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>left</span><span style=color:#111>:</span> <span style=color:#111>Node</span> <span style=color:#f92672>=</span> <span style=color:#111>left</span>
        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>right</span><span style=color:#111>:</span> <span style=color:#111>Node</span> <span style=color:#f92672>=</span> <span style=color:#111>right</span>
        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>=</span> <span style=color:#111>value</span>

    <span style=color:#75af00>@staticmethod</span>
    <span style=color:#00a8c8>def</span> <span style=color:#75af00>hash</span><span style=color:#111>(</span><span style=color:#111>val</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>str</span><span style=color:#111>:</span>
        <span style=color:#00a8c8>return</span> <span style=color:#111>hashlib</span><span style=color:#f92672>.</span><span style=color:#111>sha256</span><span style=color:#111>(</span><span style=color:#111>val</span><span style=color:#f92672>.</span><span style=color:#111>encode</span><span style=color:#111>(</span><span style=color:#d88200>&#39;utf-8&#39;</span><span style=color:#111>))</span><span style=color:#f92672>.</span><span style=color:#111>hexdigest</span><span style=color:#111>()</span>

    <span style=color:#75af00>@staticmethod</span>
    <span style=color:#00a8c8>def</span> <span style=color:#75af00>doubleHash</span><span style=color:#111>(</span><span style=color:#111>val</span><span style=color:#111>:</span> <span style=color:#111>str</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>str</span><span style=color:#111>:</span>
        <span style=color:#00a8c8>return</span> <span style=color:#111>Node</span><span style=color:#f92672>.</span><span style=color:#111>hash</span><span style=color:#111>(</span><span style=color:#111>Node</span><span style=color:#f92672>.</span><span style=color:#111>hash</span><span style=color:#111>(</span><span style=color:#111>val</span><span style=color:#111>))</span>

</code></pre></div><p>Then the Merkle tree class itself comprised of two methods for recursively building the tree, two others for printing the nodes in prefix order and the one we mentionned earlier for getting the root hash.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#00a8c8>class</span> <span style=color:#75af00>MerkleTree</span><span style=color:#111>:</span>
    <span style=color:#00a8c8>def</span> <span style=color:#111>__init__</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>values</span><span style=color:#111>:</span> <span style=color:#111>List</span><span style=color:#111>[</span><span style=color:#111>str</span><span style=color:#111>])</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>None</span><span style=color:#111>:</span>
        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__buildTree</span><span style=color:#111>(</span><span style=color:#111>values</span><span style=color:#111>)</span>

    <span style=color:#00a8c8>def</span> <span style=color:#75af00>__buildTree</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>values</span><span style=color:#111>:</span> <span style=color:#111>List</span><span style=color:#111>[</span><span style=color:#111>str</span><span style=color:#111>])</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>None</span><span style=color:#111>:</span>
        <span style=color:#111>leaves</span><span style=color:#111>:</span> <span style=color:#111>List</span><span style=color:#111>[</span><span style=color:#111>Node</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#111>Node</span><span style=color:#111>(</span><span style=color:#111>None</span><span style=color:#111>,</span> <span style=color:#111>None</span><span style=color:#111>,</span> <span style=color:#111>Node</span><span style=color:#f92672>.</span><span style=color:#111>doubleHash</span><span style=color:#111>(</span><span style=color:#111>e</span><span style=color:#111>))</span> <span style=color:#00a8c8>for</span> <span style=color:#111>e</span> <span style=color:#f92672>in</span> <span style=color:#111>values</span><span style=color:#111>]</span>
        <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>leaves</span><span style=color:#111>)</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>:</span>
            <span style=color:#111>leaves</span><span style=color:#f92672>.</span><span style=color:#111>append</span><span style=color:#111>(</span><span style=color:#111>leaves</span><span style=color:#111>[</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#111>:][</span><span style=color:#ae81ff>0</span><span style=color:#111>])</span> <span style=color:#75715e># duplicate last elem if odd number of elements</span>
        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>root</span><span style=color:#111>:</span> <span style=color:#111>Node</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__buildTreeRec</span><span style=color:#111>(</span><span style=color:#111>leaves</span><span style=color:#111>)</span>

    <span style=color:#00a8c8>def</span> <span style=color:#75af00>__buildTreeRec</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>nodes</span><span style=color:#111>:</span> <span style=color:#111>List</span><span style=color:#111>[</span><span style=color:#111>Node</span><span style=color:#111>])</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>Node</span><span style=color:#111>:</span>
        <span style=color:#111>half</span><span style=color:#111>:</span> <span style=color:#111>int</span> <span style=color:#f92672>=</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>nodes</span><span style=color:#111>)</span> <span style=color:#f92672>//</span> <span style=color:#ae81ff>2</span>

        <span style=color:#00a8c8>if</span> <span style=color:#111>len</span><span style=color:#111>(</span><span style=color:#111>nodes</span><span style=color:#111>)</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>:</span>
            <span style=color:#00a8c8>return</span> <span style=color:#111>Node</span><span style=color:#111>(</span><span style=color:#111>nodes</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>nodes</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>Node</span><span style=color:#f92672>.</span><span style=color:#111>doubleHash</span><span style=color:#111>(</span><span style=color:#111>nodes</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>+</span> <span style=color:#111>nodes</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span><span style=color:#f92672>.</span><span style=color:#111>value</span><span style=color:#111>))</span>

        <span style=color:#111>left</span><span style=color:#111>:</span> <span style=color:#111>Node</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__buildTreeRec</span><span style=color:#111>(</span><span style=color:#111>nodes</span><span style=color:#111>[:</span><span style=color:#111>half</span><span style=color:#111>])</span>
        <span style=color:#111>right</span><span style=color:#111>:</span> <span style=color:#111>Node</span> <span style=color:#f92672>=</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__buildTreeRec</span><span style=color:#111>(</span><span style=color:#111>nodes</span><span style=color:#111>[</span><span style=color:#111>half</span><span style=color:#111>:])</span>
        <span style=color:#111>value</span><span style=color:#111>:</span> <span style=color:#111>str</span> <span style=color:#f92672>=</span> <span style=color:#111>Node</span><span style=color:#f92672>.</span><span style=color:#111>doubleHash</span><span style=color:#111>(</span><span style=color:#111>left</span><span style=color:#f92672>.</span><span style=color:#111>value</span> <span style=color:#f92672>+</span> <span style=color:#111>right</span><span style=color:#f92672>.</span><span style=color:#111>value</span><span style=color:#111>)</span>
        <span style=color:#00a8c8>return</span> <span style=color:#111>Node</span><span style=color:#111>(</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>)</span>

    <span style=color:#00a8c8>def</span> <span style=color:#75af00>printTree</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>None</span><span style=color:#111>:</span>
        <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__printTreeRec</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>root</span><span style=color:#111>)</span>

    <span style=color:#00a8c8>def</span> <span style=color:#75af00>__printTreeRec</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>,</span> <span style=color:#111>node</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>None</span><span style=color:#111>:</span>
        <span style=color:#00a8c8>if</span> <span style=color:#111>node</span> <span style=color:#f92672>!=</span> <span style=color:#111>None</span><span style=color:#111>:</span>
            <span style=color:#00a8c8>print</span><span style=color:#111>(</span><span style=color:#111>node</span><span style=color:#f92672>.</span><span style=color:#111>value</span><span style=color:#111>)</span>
            <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__printTreeRec</span><span style=color:#111>(</span><span style=color:#111>node</span><span style=color:#f92672>.</span><span style=color:#111>left</span><span style=color:#111>)</span>
            <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>__printTreeRec</span><span style=color:#111>(</span><span style=color:#111>node</span><span style=color:#f92672>.</span><span style=color:#111>right</span><span style=color:#111>)</span>

    <span style=color:#00a8c8>def</span> <span style=color:#75af00>getRootHash</span><span style=color:#111>(</span><span style=color:#111>self</span><span style=color:#111>)</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>str</span><span style=color:#111>:</span>
        <span style=color:#00a8c8>return</span> <span style=color:#111>self</span><span style=color:#f92672>.</span><span style=color:#111>root</span><span style=color:#f92672>.</span><span style=color:#111>value</span>
</code></pre></div><p>We can then test our data structure by sending in a list of strings and getting its corresponding merkle tree root hash.</p><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#00a8c8>def</span> <span style=color:#75af00>test</span><span style=color:#111>()</span><span style=color:#f92672>-&gt;</span> <span style=color:#111>None</span><span style=color:#111>:</span>
    <span style=color:#111>elems</span> <span style=color:#f92672>=</span> <span style=color:#111>[</span><span style=color:#d88200>&#34;Hello&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;mister&#34;</span><span style=color:#111>,</span> <span style=color:#d88200>&#34;Merkle&#34;</span><span style=color:#111>]</span>
    <span style=color:#111>mtree</span> <span style=color:#f92672>=</span> <span style=color:#111>MerkleTree</span><span style=color:#111>(</span><span style=color:#111>elems</span><span style=color:#111>)</span>
    <span style=color:#00a8c8>print</span><span style=color:#111>(</span><span style=color:#111>mtree</span><span style=color:#f92672>.</span><span style=color:#111>getRootHash</span><span style=color:#111>())</span>
</code></pre></div><div class=highlight><pre style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>~$ python3.6 merkletree.py
8617d7a42c4ef170227e97fc407a9af29e1d52db4a0dcff56a039fd16cde0f69
</code></pre></div><p>That&rsquo;s it! Feel free to try this code and improve it at will.</p><p>Bye for now!</p></div><div class=tags><ul class=flat><li><a href=/tags/development>development</a></li></ul></div></div></div><div class="footer wrapper"><nav class=nav><div>2021 <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>